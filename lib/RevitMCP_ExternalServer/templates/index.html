<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevitMCP Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Settings Modal (hidden by default) -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Settings</h2>
            <div>
                <label for="api-key-modal">API Key:</label>
                <input type="password" id="api-key-modal" name="api-key-modal" placeholder="Enter your API key">
            </div>
            <div>
                <label for="model-select-modal">Model:</label>
                <select id="model-select-modal" name="model-select-modal">
                    <option value="">--Select a Model--</option>
                    <optgroup label="OpenAI">
                        <option value="gpt-4o">OpenAI - GPT-4o (Recommended)</option>
                        <option value="gpt-4.1">OpenAI - GPT-4.1 (Coding Focus)</option>
                        <option value="gpt-4o-mini">OpenAI - GPT-4o mini (Cost-Effective)</option>
                        <option value="o1">OpenAI - O1 (Advanced Reasoning)</option>
                        <option value="gpt-4-turbo">OpenAI - GPT-4 Turbo</option>
                        <option value="gpt-3.5-turbo">OpenAI - GPT-3.5 Turbo</option>
                    </optgroup>
                    <optgroup label="Anthropic">
                        <option value="claude-opus-4-20250514">Anthropic - Claude Opus 4</option>
                        <option value="claude-sonnet-4-20250514">Anthropic - Claude Sonnet 4 (Recommended)</option>
                        <option value="claude-3.5-sonnet-latest">Anthropic - Claude 3.5 Sonnet</option>
                        <option value="claude-3.5-haiku-latest">Anthropic - Claude 3.5 Haiku (Fastest)</option>
                    </optgroup>
                    <optgroup label="Google">
                        <option value="gemini-2.5-pro-preview">Google - Gemini 2.5 Pro (Preview)</option>
                        <option value="gemini-2.5-flash-preview">Google - Gemini 2.5 Flash (Preview)</option>
                        <option value="gemini-2.0-flash">Google - Gemini 2.0 Flash (GA)</option>
                        <option value="gemini-2.0-flash-lite">Google - Gemini 2.0 Flash-Lite (GA - Cost-Effective)</option>
                    </optgroup>
                    <option value="echo_model">--------------------</option>
                    <option value="echo_model">Echo Model (Testing)</option>
                </select>
            </div>
            <button id="save-settings-modal">Save Settings</button>
        </div>
    </div>

    <div class="chat-container">
        <div id="chat-log" class="chat-log">
            <div class="message bot-message">Welcome to RevitMCP Chat! Click the ⚙️ icon to set your API key and select a model.</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button id="send-button">Send</button>
            <button id="settings-button" class="settings-icon">⚙️</button>
        </div>
    </div>

    <script>
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        
        // Modal elements
        const settingsModal = document.getElementById('settings-modal');
        const settingsButton = document.getElementById('settings-button');
        const closeButton = document.querySelector('.modal-content .close-button'); // More specific selector
        const apiKeyInputModal = document.getElementById('api-key-modal');
        const modelSelectModal = document.getElementById('model-select-modal');
        const saveSettingsButtonModal = document.getElementById('save-settings-modal');

        // Conversation history array
        let conversationHistory = [];

        function appendMessage(text, sender, isSystemMessage) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            messageDiv.textContent = text;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
            
            if (!isSystemMessage) { // Only add actual chat messages to history
                conversationHistory.push({role: sender, content: text});
            }
        }

        function loadSettings() {
            const savedApiKey = localStorage.getItem('apiKey');
            const savedModel = localStorage.getItem('selectedModel');
            if (savedApiKey) {
                apiKeyInputModal.value = savedApiKey;
            }
            if (savedModel) {
                modelSelectModal.value = savedModel;
            } else {
                modelSelectModal.value = 'gpt-4o'; // Default model
            }
        }

        // Event listeners for modal
        settingsButton.addEventListener('click', () => {
            settingsModal.style.display = 'block';
            loadSettings(); 
        });

        closeButton.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === settingsModal) { // Check if the click is on the modal backdrop itself
                settingsModal.style.display = 'none';
            }
        });

        saveSettingsButtonModal.addEventListener('click', () => {
            const apiKey = apiKeyInputModal.value;
            const selectedModel = modelSelectModal.value;
            localStorage.setItem('apiKey', apiKey);
            localStorage.setItem('selectedModel', selectedModel);
            appendMessage('Settings saved!', 'bot-message', true); // System message
            settingsModal.style.display = 'none';
        });

        async function sendMessage() {
            const messageText = userInput.value.trim();
            const apiKey = apiKeyInputModal.value.trim();
            const selectedModel = modelSelectModal.value;

            if (messageText === '') return;

            if (selectedModel === '') {
                appendMessage('Please select a model in settings (⚙️) first.', 'bot-message', true);
                return;
            }
            if (selectedModel !== 'echo_model' && apiKey === '') {
                appendMessage('Please enter your API key in settings (⚙️).', 'bot-message', true);
                return;
            }

            appendMessage(messageText, 'user'); // Add user message to UI and history
            userInput.value = '';
            
            let payloadConversation;
            if (selectedModel !== 'echo_model') {
                // For actual LLMs, send the current conversation history
                // The user's current message was already added by appendMessage
                payloadConversation = [...conversationHistory]; 
            } else {
                // For echo model, just send the current message object
                payloadConversation = [{role: 'user', content: messageText}];
            }

            try {
                const response = await fetch('/chat_api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation: payloadConversation,
                        apiKey: apiKey,
                        model: selectedModel 
                    }),
                });

                if (!response.ok) {
                    let errorMsg = `Server error: ${response.statusText}`;
                    try {
                         const errorData = await response.json();
                         errorMsg = `Error: ${errorData.error || errorData.message || response.statusText}`;
                    } catch (e) { /* Ignore if response is not JSON */ }
                    appendMessage(errorMsg, 'bot-message', true);
                    
                    // If the call failed, remove the user's last message from history
                    // as it wasn't successfully processed by the backend.
                    if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length-1].role === 'user') {
                       if(conversationHistory[conversationHistory.length-1].content === messageText){
                           conversationHistory.pop();
                       }
                    }
                    return;
                }

                const data = await response.json();
                appendMessage(data.reply, 'bot'); // Add bot's reply to UI and history

            } catch (error) {
                console.error('Error sending message:', error);
                appendMessage('Error: Could not connect to the server.', 'bot-message', true);
                 // If the call failed, remove the user's last message from history
                if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length-1].role === 'user') {
                    if(conversationHistory[conversationHistory.length-1].content === messageText){
                        conversationHistory.pop();
                    }
                }
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>
</html> 
</html> 